<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Metadata -->
    <meta charset="utf-8">
    <title>Bridge web component demo</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <meta property="og:title" content="">
    <meta property="og:type" content="">
    <meta property="og:url" content="">
    <meta property="og:image" content="">


    <!-- Fonts -->
    <!--<link rel="stylesheet" type="text/css" href="https://bridgefont.s3.us-east-2.amazonaws.com/fonts.css"> -->

    <style>
        html {
            color: #7a8294;
            font-size: 16px;
            font-family: 'metropolis-medium';
            font-weight: normal;
            line-height: 1.4;
            background-image: -moz-linear-gradient( 135deg, rgb(213,221,241) 0%, rgb(241,244,249) 100%);
            background-image: -webkit-linear-gradient( 135deg, rgb(213,221,241) 0%, rgb(241,244,249) 100%);
            background-image: -ms-linear-gradient( 135deg, rgb(213,221,241) 0%, rgb(241,244,249) 100%);
            min-width: 1280px;
        }
    </style>

    <meta name="msapplication-TileColor" content="#f1f4f9">
    <meta name="theme-color" content="#f1f4f9">
</head>
<body>

    <button onclick="dispatchSendTransactionEvent()">Send Transaction</button>
    <button onclick="dispatchOpenBridgeEvent()">Open Bridge</button>
    <button onclick="dispatchCloseBridgeEvent()">Close Bridge</button>
    <button onclick="dispatchLogoutFromBridgeEvent()">Logout from Bridge</button>

    <script>
        var bridgeUserLoggedIn = false;

        window.addEventListener("bri.tx.result", handleTxResult)
        window.addEventListener("bri.login", handleBridgeLogin)
        window.addEventListener("bri.widget.res", handleWidgetRes)
        window.addEventListener("bri.logout.res", handleBridgeLogoutRes)

        function dispatchLogoutFromBridgeEvent() {
            window.dispatchEvent(new CustomEvent('bri.widget', {
                detail: {
                    action: "logout"
                }
            }))
        }

        function dispatchOpenBridgeEvent() {
            window.dispatchEvent(new CustomEvent('bri.widget', {
                detail: {
                    action: "open"
                }
            }))
        }

        function dispatchCloseBridgeEvent() {
            window.dispatchEvent(new CustomEvent('bri.widget', {
                detail: {
                    action: "close"
                }
            }))
        }

        // Dispatch Event
        function dispatchSendTransactionEvent() {
            if (!bridgeUserLoggedIn) alert("User not logged in Bridge!");

            const userIconAddress = localStorage.getItem("BRIDGE_USER_ICON_ADDRESS")

            if(!!userIconAddress){
                console.log("Preparing USDS transaction for address " + userIconAddress)
                const customEvent = new CustomEvent('bri.send.tx', {
                    detail: {
                        payload: {
                            "to": "cx1a52a17ee1a2a6bb52e31fc80bee692baa7455a0", // Score Address
                            "from": userIconAddress,
                            "stepLimit": "0x1e8480",
                            "nid": "0x3",
                            "version": "0x3",
                            "timestamp": (new Date()).getTime() * 1000,
                            "nonce": "0x1",
                            "dataType": "call",
                            "data": {
                                "method": "transfer",
                                "params": {
                                    "_to": "hx9f2173c968820a816e1c5e101dbb9ed7c14b616b", // USDS Receiver Address
                                    "_value":"0x53444835ec580000"}                       // USDS Amount
                            }
                        }
                    }
                })

                window.dispatchEvent(customEvent)
            }
            else {
                console.error("No user icon address found. Bridge user not logged in?")
            }
        }

        function handleWidgetRes(event) {
            console.log("handleWidgetRes:", event);
        }

        // Handle Event Result
        function handleTxResult(event){
            const {txHash, error, status} = event.detail
            console.log(txHash)
            console.log(error)
            console.log(status)
        }

        // Handle when user log in with Bridge
        function handleBridgeLogin(event) {
            bridgeUserLoggedIn = true
            const {publicAddress, email} = event.detail;
            console.log("User logged in.")
            console.log("Users public Icon address from event = " + publicAddress);
            console.log("Users public Icon address from localstorage = " + localStorage.getItem("BRIDGE_USER_ICON_ADDRESS"));
        }

        // Handle when user logs out from Bridge
        function handleBridgeLogoutRes(event) {
            const {publicAddress, email} = event.detail;
            console.log(`User with publicAddress=${publicAddress}, email=${email} logged out.`);
        }
    </script>

    <div style="position: fixed; top: 50%; left: 50%; margin-top: -50px;margin-left: -100px;">
        <icon-bridge-widget></icon-bridge-widget>
        <p class="text-center">Â© Bridge 2020, All rights reserved.</p>
    </div>
    <footer>
    </footer>
<script src="bridge.bundle.js"></script></body>
</html>
